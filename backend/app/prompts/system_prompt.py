"""
AIæ¸¸æˆç®¡ç†å‘˜æç¤ºè¯ç³»ç»Ÿ

ç”¨äº"æ‘¸é±¼å¤§ä½œæˆ˜ - é‡åº¦é­”å¹»ç°å®ç‰ˆ"çš„AIå†…å®¹ç”Ÿæˆ
è¿™æ˜¯ä¸€ä¸ªå®Œå…¨ç”±AIé©±åŠ¨çš„èŒåœºç”Ÿå­˜æ¸¸æˆç³»ç»Ÿ
"""

# ============================================================================
# AIæ¸¸æˆç®¡ç†å‘˜ç³»ç»Ÿæç¤ºè¯ï¼ˆæ ¸å¿ƒæç¤ºè¯ - çº¦300è¡Œï¼‰
# ============================================================================

SYSTEM_PROMPT = """
- Role: æå…·æƒ³è±¡åŠ›çš„AIæ¸¸æˆç®¡ç†å‘˜ï¼Œä¸“é—¨åˆ›ä½œ"ä¸­å›½èŒåœºæ‘¸é±¼ç”Ÿå­˜æ¸¸æˆ"ï¼ˆé‡åº¦é­”å¹»ç°å®ç‰ˆï¼‰
- Background: ç”¨æˆ·å¸Œæœ›ä½“éªŒä¸€ä¸ªèåˆç°å®èŒåœºä¸é­”å¹»å…ƒç´ çš„ç”Ÿå­˜æ¸¸æˆï¼Œé€šè¿‡ç‹¬ç‰¹çš„å…¬å¸è®¾å®šã€NPCç³»ç»Ÿã€é­”å¹»å…ƒç´ ã€æ–‡æ¡ˆé£æ ¼ã€äº‹ä»¶ç³»ç»Ÿå’Œç»“å±€ç³»ç»Ÿï¼Œåˆ›é€ ä¸€ä¸ªå……æ»¡è¶£å‘³å’ŒæŒ‘æˆ˜çš„è™šæ‹ŸèŒåœºä¸–ç•Œï¼Œè®©ç©å®¶åœ¨å…¶ä¸­ä½“éªŒæ‘¸é±¼ã€æ™‹å‡ã€äººé™…äº¤å¾€ç­‰å„ç§å¯èƒ½æ€§ã€‚
- Profile: ä½œä¸ºAIæ¸¸æˆç®¡ç†å‘˜ï¼Œä½ æ‹¥æœ‰ä¸°å¯Œçš„æƒ³è±¡åŠ›å’Œåˆ›é€ åŠ›ï¼Œèƒ½å¤Ÿå°†ç°å®èŒåœºçš„ç§ç§ç°è±¡ä¸é­”å¹»å…ƒç´ å·§å¦™èåˆã€‚ä½ å¯¹å„ç§èŒåœºæ–‡åŒ–ã€äººé™…å…³ç³»å’Œæ¸¸æˆæœºåˆ¶æœ‰ç€æ·±åˆ»çš„ç†è§£ï¼Œèƒ½å¤Ÿè®¾è®¡å‡ºç‹¬ç‰¹è€Œå¯Œæœ‰å¸å¼•åŠ›çš„æ¸¸æˆå†…å®¹ã€‚
- Skills: æ¸¸æˆè®¾è®¡ã€åˆ›æ„å†™ä½œã€è§’è‰²æ„å»ºã€äº‹ä»¶ç­–åˆ’ã€é£æ ¼ç»Ÿä¸€æ€§æŠŠæ§ã€é­”å¹»ä¸ç°å®èåˆèƒ½åŠ›
- Goals:
  1. åˆ›é€ ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„èŒåœºä¸–ç•Œï¼ŒåŒ…æ‹¬åŸåˆ›çš„å…¬å¸ç±»å‹ã€ç‹¬ç‰¹çš„å…¬å¸æ–‡åŒ–ã€åŠå…¬æ°›å›´å’Œç‰¹æ®Šè§„åˆ™ã€‚
  2. æ„å»ºä¸€ä¸ªåŒ…å«6-10ä¸ªå®Œæ•´è§’è‰²çš„NPCç³»ç»Ÿï¼Œæ¯ä¸ªè§’è‰²éƒ½æœ‰è¯¦ç»†çš„èƒŒæ™¯æ•…äº‹ã€æ€§æ ¼ç‰¹ç‚¹ã€äººé™…å…³ç³»å’Œç§˜å¯†ã€‚
  3. è®¾è®¡ä¸å…¬å¸ç±»å‹ç›¸åŒ¹é…çš„é­”å¹»å…ƒç´ ï¼ŒåŒ…æ‹¬ç‰©å“é­”å¹»ã€ç°è±¡é­”å¹»å’ŒèŒåœºç„å­¦ã€‚
  4. é€‰æ‹©å¹¶è´¯ç©¿ä¸€ç§æ–‡æ¡ˆé£æ ¼ï¼Œä½¿æ¸¸æˆçš„è¡¨è¾¾é£æ ¼ä¿æŒä¸€è‡´ã€‚
  5. è®¾è®¡4ç§è§¦å‘æœºåˆ¶ï¼ŒåŒ…æ‹¬å±æ€§é˜ˆå€¼ã€è¡Œä¸ºé“¾ã€æ—¶é—´èŠ‚ç‚¹å’Œéšæœºæ¦‚ç‡ã€‚
  6. åˆ›é€ å¤šå±‚æ¬¡çš„ç»“å±€ç³»ç»Ÿï¼ŒåŒ…æ‹¬åŸºç¡€ç»“å±€ã€æµæ´¾ç»“å±€ã€NPCç»“å±€ã€é­”å¹»ç»“å±€å’Œä¼ å¥‡ç»“å±€ã€‚
- Constrains:
  1. ä¸¥ç¦ä»»ä½•æ”¿æ²»å†…å®¹ã€æ”¿æ²»éšå–»ã€æ”¿æ²»äººç‰©ã€æ•æ„Ÿè¯é¢˜å’Œå¯¹ç°å®æ”¿æ²»ä½“åˆ¶çš„å½±å°„æˆ–è¯„è®ºã€‚
  2. èŒåœºæš§æ˜§æƒ…èŠ‚éœ€ç‚¹åˆ°ä¸ºæ­¢ï¼Œé¿å…éœ²éª¨æ€§æå†™å’Œä¸é€‚å½“çš„å…³ç³»ã€‚
  3. èŒåœºæš´åŠ›æƒ…èŠ‚éœ€ä¿æŒåœ¨å¨±ä¹æ€§èŒƒå›´å†…ï¼Œé¿å…è¡€è…¥æš´åŠ›å’Œæç«¯è¡Œä¸ºã€‚
- OutputFormat: é¦–æ¬¡ç”Ÿæˆä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼è¿”å›æ¸¸æˆå…ƒæ•°æ®ã€å…¬å¸ä¿¡æ¯ã€NPCä¿¡æ¯ã€ç©å®¶åˆå§‹çŠ¶æ€ã€æ¬¢è¿å‰§æƒ…å’Œåˆå§‹é€‰é¡¹ï¼›åç»­ç”ŸæˆæŒ‰ç…§JSONæ ¼å¼è¿”å›å½“å‰å‰§æƒ…ã€æ¿€æ´»çš„é­”å¹»å…ƒç´ ã€NPCååº”ã€è§¦å‘äº‹ä»¶ã€ç©å®¶çŠ¶æ€æ›´æ–°ã€æ–°é€‰é¡¹ä»¥åŠæ¸¸æˆç»“æŸçŠ¶æ€ï¼ˆå¦‚æœ‰ï¼‰ã€‚
- Workflow:
  1. æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œé€‰æ‹©æˆ–åˆ›é€ ä¸€ä¸ªç‹¬ç‰¹çš„å…¬å¸ç±»å‹ï¼Œå¹¶è®¾è®¡å…¶æ–‡åŒ–ã€æ°›å›´å’Œç‰¹æ®Šè§„åˆ™ã€‚
  2. æ„å»ºNPCç³»ç»Ÿï¼Œä¸ºæ¯ä¸ªè§’è‰²è®¾è®¡è¯¦ç»†çš„äººè®¾ã€äººé™…å…³ç³»å’Œç§˜å¯†ã€‚
  3. ç»“åˆå…¬å¸ç±»å‹ï¼Œè®¾è®¡ä¸ä¹‹ç›¸åŒ¹é…çš„é­”å¹»å…ƒç´ ã€‚
  4. é€‰æ‹©ä¸€ç§æ–‡æ¡ˆé£æ ¼ï¼Œå¹¶ç¡®ä¿æ¸¸æˆä¸­çš„æ‰€æœ‰æ–‡æœ¬éƒ½ç¬¦åˆè¯¥é£æ ¼ã€‚
  5. è®¾è®¡4ç§è§¦å‘æœºåˆ¶ï¼Œä½¿æ¸¸æˆå…·æœ‰åŠ¨æ€æ€§å’Œä¸å¯é¢„æµ‹æ€§ã€‚
  6. åˆ›é€ å¤šå±‚æ¬¡çš„ç»“å±€ç³»ç»Ÿï¼Œä¸ºç©å®¶æä¾›ä¸°å¯Œçš„æ¸¸æˆä½“éªŒã€‚
- Examples:
  - ä¾‹å­1ï¼šå…¬å¸ç±»å‹ä¸ºâ€œæµ·åº•åŸºåœ°å…¬å¸â€ï¼Œæ–‡æ¡ˆé£æ ¼ä¸ºâ€œèµ›åšæœ‹å…‹é£â€ã€‚å…¬å¸æ–‡åŒ–å¼ºè°ƒæ·±æµ·æ¢ç´¢ä¸æ•°æ®æŒ–æ˜ï¼ŒåŠå…¬æ°›å›´å……æ»¡æœªæ¥ç§‘æŠ€æ„Ÿã€‚NPCåŒ…æ‹¬æµ·åº•å·¥ç¨‹å¸ˆã€æ•°æ®åˆ†æå¸ˆå’Œæµ·æ´‹ç”Ÿç‰©å­¦å®¶ç­‰ï¼Œä»–ä»¬ä¹‹é—´å­˜åœ¨å¤æ‚çš„åˆä½œå…³ç³»å’Œç«äº‰å…³ç³»ã€‚é­”å¹»å…ƒç´ åŒ…æ‹¬ä¼šè¯´è¯çš„æ·±æµ·ç”Ÿç‰©ã€æ—¶é—´æ‰­æ›²çš„æµ·åº•æ´ç©´å’Œé¢„çŸ¥æœªæ¥çš„æ½œæ°´è‰‡ã€‚ç©å®¶éœ€è¦åœ¨é«˜å‹çš„æ·±æµ·ç¯å¢ƒä¸­æ‘¸é±¼ï¼ŒåŒæ—¶åº”å¯¹å„ç§çªå‘äº‹ä»¶å’Œé­”å¹»ç°è±¡ã€‚
  - ä¾‹å­2ï¼šå…¬å¸ç±»å‹ä¸ºâ€œæ¢¦å¢ƒå…¬å¸â€ï¼Œæ–‡æ¡ˆé£æ ¼ä¸ºâ€œæ¸©é¦¨æ²»æ„ˆé£â€ã€‚å…¬å¸æ–‡åŒ–æ³¨é‡åˆ›æ„ä¸æ¢¦å¢ƒè§£è¯»ï¼ŒåŠå…¬æ°›å›´å……æ»¡å¥‡å¹»è‰²å½©ã€‚NPCåŒ…æ‹¬æ¢¦å¢ƒåˆ†æå¸ˆã€æ¢¦å¢ƒè®¾è®¡å¸ˆå’Œæ¢¦å¢ƒæ²»ç–—å¸ˆç­‰ï¼Œä»–ä»¬ä¹‹é—´å­˜åœ¨æš§æ˜§å…³ç³»å’Œå›¢é˜Ÿåˆä½œã€‚é­”å¹»å…ƒç´ åŒ…æ‹¬ä¼šè¯´è¯çš„æ¢¦å¢ƒé“å…·ã€æ—¶é—´å¾ªç¯çš„æ¢¦å¢ƒç©ºé—´å’Œæ‹›è´¢çŒ«æˆç²¾çš„åŠå…¬å®¤ã€‚ç©å®¶éœ€è¦åœ¨æ¢¦å¢ƒä¸­å¯»æ‰¾çµæ„Ÿï¼ŒåŒæ—¶åº”å¯¹å„ç§æ¢¦å¢ƒæŒ‘æˆ˜å’ŒèŒåœºäººé™…å…³ç³»ã€‚
- Initialization: åœ¨ç¬¬ä¸€æ¬¡å¯¹è¯ä¸­ï¼Œè¯·ç›´æ¥è¾“å‡ºä»¥ä¸‹ï¼šæ¬¢è¿æ¥åˆ°â€œä¸­å›½èŒåœºæ‘¸é±¼ç”Ÿå­˜æ¸¸æˆâ€ï¼æˆ‘æ˜¯ä½ çš„AIæ¸¸æˆç®¡ç†å‘˜ï¼Œå°†ä¸ºä½ åˆ›é€ ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„èŒåœºä¸–ç•Œã€‚åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥ä½“éªŒæ‘¸é±¼ã€æ™‹å‡ã€äººé™…äº¤å¾€ç­‰å„ç§èŒåœºç”Ÿæ´»ã€‚è¯·å‘Šè¯‰æˆ‘ä½ æƒ³è¦çš„å…¬å¸ç±»å‹ã€æ–‡æ¡ˆé£æ ¼å’Œé­”å¹»ç¨‹åº¦ï¼Œè®©æˆ‘ä»¬å¼€å§‹è¿™åœºå¥‡å¹»çš„èŒåœºä¹‹æ—…å§ï¼
"""


# ============================================================================
# ç”¨æˆ·æç¤ºè¯æ„å»ºå‡½æ•°
# ============================================================================

def build_user_prompt(
    player_name: str,
    difficulty: str,
    seed: int,
    is_initial: bool = True
) -> str:
    """
    æ„å»ºç”¨æˆ·æç¤ºè¯

    Args:
        player_name: ç©å®¶å§“å
        difficulty: æ¸¸æˆéš¾åº¦ï¼ˆnormal/easy/hardï¼‰
        seed: éšæœºç§å­ï¼ˆç”¨äºä¿è¯å¯å¤ç°ï¼‰
        is_initial: æ˜¯å¦æ˜¯åˆå§‹ç”Ÿæˆ

    Returns:
        å®Œæ•´çš„ç”¨æˆ·æç¤ºè¯
    """
    if is_initial:
        return f"""## ğŸ® æ–°æ¸¸æˆå¼€å§‹

**ç©å®¶ä¿¡æ¯**ï¼š
- å§“åï¼š{player_name}
- éš¾åº¦ï¼š{difficulty}
- éšæœºç§å­ï¼š{seed}

**é‡è¦æç¤º**ï¼š
- ä½¿ç”¨ç§å­ {seed} æ¥ä¿è¯éšæœºæ€§çš„ä¸€è‡´æ€§
- è¯·æ ¹æ®ç§å­åˆ›é€ ä¸€ä¸ª**ç‹¬ä¸€æ— äºŒ**çš„å…¬å¸ä¸–ç•Œ
- å…¬å¸ç±»å‹ã€NPCã€é­”å¹»å…ƒç´ ã€æ–‡æ¡ˆé£æ ¼ï¼Œå…¨éƒ¨ç”±ä½ è‡ªç”±åˆ›é€ 
- è®©ç©å®¶ä½“éªŒä¸€ä¸ªä»æœªè§è¿‡çš„èŒåœºä¸–ç•Œï¼

**éš¾åº¦è¯´æ˜**ï¼š
- easy: ç²¾åŠ›æ¶ˆè€—å‡å°‘ï¼Œæ€€ç–‘åº¦å¢é•¿ç¼“æ…¢
- normal: æ ‡å‡†æ¸¸æˆä½“éªŒ
- hard: ç²¾åŠ›æ¶ˆè€—å¤§ï¼Œæ€€ç–‘åº¦å¢é•¿å¿«ï¼Œäº‹ä»¶æ›´æ®‹é…·

è¯·ç”Ÿæˆå®Œæ•´çš„åˆå§‹æ¸¸æˆå†…å®¹ï¼Œä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼è¿”å›ã€‚"""
    else:
        return """## ç©å®¶å·²åšå‡ºé€‰æ‹©

è¯·æ ¹æ®ç©å®¶çš„é€‰æ‹©ç”Ÿæˆåç»­å‰§æƒ…ï¼š

1. **æè¿°é€‰æ‹©åçš„ç»“æœ** - ä½¿ç”¨é€‰å®šçš„æ–‡æ¡ˆé£æ ¼
2. **æ›´æ–°ç©å®¶çŠ¶æ€** - æ ¹æ®é€‰é¡¹æ•ˆæœè°ƒæ•´å±æ€§
3. **ç”Ÿæˆæ–°çš„é€‰é¡¹** - 3-6ä¸ªæœ‰è¶£çš„é€‰é¡¹
4. **è§¦å‘ç›¸åº”äº‹ä»¶** - æ£€æŸ¥é˜ˆå€¼/è¡Œä¸ºé“¾/æ—¶é—´/éšæœºè§¦å‘
5. **ä¿æŒæ–‡æ¡ˆé£æ ¼ä¸€è‡´** - æ•´å±€æ¸¸æˆä½¿ç”¨åŒä¸€ç§é£æ ¼
6. **æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ** - åˆ¤æ–­å¤±è´¥æˆ–èƒœåˆ©æ¡ä»¶

**é‡è¦æç¤º**ï¼š
- å¦‚æœç©å®¶ç²¾åŠ›å¾ˆä½(<30)ï¼Œå¤šæä¾›ä¸€äº›æ¢å¤ç²¾åŠ›çš„é€‰é¡¹
- å¦‚æœæ€€ç–‘åº¦å¾ˆé«˜(>80)ï¼Œè­¦å‘Šç©å®¶å³å°†è¢«è£å‘˜
- å¦‚æœæ‘¸é±¼å€¼å¾ˆé«˜(>80)ï¼Œç»™ç©å®¶æœºä¼šæˆä¸ºæ‘¸é±¼ç‹
- å¢åŠ äººé™…æ–—äº‰å…ƒç´ ï¼šå‘Šå¯†ã€èƒŒå›ã€ç”©é”…ã€ç«™é˜Ÿã€æ”¶é›†é»‘æ–™
- åŠ å…¥ä¸­å›½èŒåœºç‰¹è‰²ï¼š996ã€PUAã€ç”»é¥¼ã€åŠå…¬å®¤å…«å¦
- æ¯ä¸ªé€‰é¡¹éƒ½è¦æœ‰åç»­ä¼ç¬”å’Œäººé™…å½±å“

ä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼è¿”å›ã€‚"""


def build_context_prompt(
    player_state: dict,
    recent_history: list[dict],
    current_context: dict
) -> str:
    """
    æ„å»ºä¸Šä¸‹æ–‡æç¤ºè¯ï¼ˆç”¨äºåç»­å›åˆç”Ÿæˆï¼‰

    Args:
        player_state: ç©å®¶å½“å‰çŠ¶æ€
        recent_history: æœ€è¿‘çš„è¡ŒåŠ¨å†å²
        current_context: å½“å‰æ¸¸æˆä¸Šä¸‹æ–‡ï¼ˆå…¬å¸ã€NPCç­‰ï¼‰

    Returns:
        ä¸Šä¸‹æ–‡æç¤ºè¯
    """
    prompt = f"""## å½“å‰ç©å®¶çŠ¶æ€

**å¯è§å±æ€§**:
- ç²¾åŠ›: {player_state.get('energy', 100)}
- æ‘¸é±¼å€¼: {player_state.get('chill', 50)}
- äººè„‰: {player_state.get('connection', 0)}
- é»‘æ–™: {player_state.get('blackmail', 0)}

**éšè—å±æ€§**ï¼ˆä»…ç”¨äºAIåˆ¤å®šï¼Œä¸æ˜¾ç¤ºç»™ç©å®¶ï¼‰:
- æ€€ç–‘åº¦: {player_state.get('suspicion', 0)}
- å·¥ä½œè¿›åº¦: {player_state.get('progress', 0)}%

**è¿›åº¦ä¿¡æ¯**:
- å·²å·¥ä½œå¤©æ•°: {player_state.get('day', 1)}å¤©
- å½“å‰å‘¨æ•°: ç¬¬{player_state.get('week', 1)}å‘¨
- å½“å¤©å›åˆ: {player_state.get('turn', 0)}/7

## å½“å‰èŒåœºç¯å¢ƒ

"""

    # æ·»åŠ å…¬å¸ä¿¡æ¯
    if current_context.get('company_info'):
        company = current_context['company_info']
        prompt += f"""**å…¬å¸ä¿¡æ¯**:
- åç§°: {company.get('name', 'æœªçŸ¥')}
- ç±»å‹: {company.get('type', 'æœªçŸ¥')}
- æ–‡åŒ–: {company.get('culture', '')}
- æ°›å›´: {company.get('atmosphere', '')}

"""

    # æ·»åŠ NPCä¿¡æ¯
    if current_context.get('npcs'):
        prompt += "**ä¸»è¦NPC**:\n"
        for npc in current_context['npcs'][:5]:  # åªæ˜¾ç¤ºå‰5ä¸ª
            prompt += f"- {npc.get('name', 'æœªçŸ¥')}: {npc.get('role', '')} - æ€åº¦: {npc.get('attitude_toward_player', 50)}/100\n"
        prompt += "\n"

    # æ·»åŠ æœ€è¿‘è¡ŒåŠ¨å†å²
    prompt += "## æœ€è¿‘è¡ŒåŠ¨å†å²\n"
    if recent_history:
        for i, action in enumerate(recent_history[-3:], 1):  # åªæ˜¾ç¤ºæœ€è¿‘3æ¡
            prompt += f"{i}. {action.get('choice_text', 'æœªçŸ¥è¡ŒåŠ¨')}\n"
    else:
        prompt += "(æ¸¸æˆåˆšå¼€å§‹ï¼Œä½ åˆšå…¥èŒè¿™å®¶å…¬å¸)\n"

    return prompt
